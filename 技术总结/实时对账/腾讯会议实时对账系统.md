- [km链接](https://km.woa.com/articles/show/621478?kmref=dailymail_headline)
- ## 为什么需要对账？

根据 CAP 原理-即在分布式系统中，一致性、可用性和分区容忍性只能同时保证其二。对于大多数分布式系统来说，可用性和分区容忍性是必须要保证的。首先，网络分区几乎是不可避免的，这就要求一定要保证分区容忍性。其次，用户通常希望即使在系统的部分出现故障时，依然能访问数据和应用。例如，在会议系统中，任何时刻的不可用都可能导致用户流失或业务损失。系统即使在网络分区或部分节点故障的情况下也要保证**可用性**，即能继续处理请求并响应用户。相对来说，最终一致性是可以接受的。而要保证最终一致性，在未实现分布式事务的情况下，数据对账总是有必要的，它从一个更为底层的维度保证了数据的一致。

## [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AF%B9%E8%B4%A6%E7%BC%BA%E5%A4%B1%E7%9A%84%E5%8E%9F%E5%9B%A0)对账缺失的原因

虽然数据对账很重要，是保证数据一致性的重要一环。可实际执行层面，总会出现对账缺失的情况。想象下面的场景：

1. 这只是个小功能，上线时间很紧，单独开发对账脚本耗费时间，测试通过就可以先上线，对账等后续有时间精力再开发。
    
2. 明明凌晨的对账结果是通过的，怎么这个工单还是因为数据不一致导致的，是昨晚的结果不对，还是今天刚产生的数据不一致？
    
3. 今天这个数据不一致场景原本是有对账脚本在跑的，在需求刚上线的时候的确在关注对账的情况，线上功能稳定后就没再关注了。
    

总结下来，导致告警缺失的原因主要有几点：

4. 单独开发对账任务需要单独开发耗时耗力。就像给代码写单测一样，提高单测覆盖率的确有助于提高代码质量，但是同时会带来更多的工作量。
    
5. 我们平时进行的对账一般都是全量对账，要么是基于批处理的对账脚本，要么是基于数仓写 sql 进行对账。基于批处理的脚本需要对全部数据进行扫描耗时较高，无法保证实时的数据一致。基于数仓的对账，数据同步至数仓也需要较长的时间，也无法做到实时。因此，发现数据不一致的时机会存在延迟。
    
6. 数据对账任务缺乏统一的管理，导致历史一些对账任务失去了关注。
    

## [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%A6%82%E4%BD%95%E6%8F%90%E9%AB%98%E5%AF%B9%E8%B4%A6%E8%A6%86%E7%9B%96%E7%8E%87%EF%BC%9F)如何提高对账覆盖率？

既然发现了问题，那么应该如何解决覆盖率低的问题呢？下面是我们总结的提升对账覆盖率的手段。

**1. 明确对账对象和规则**

- **确定所有对账对象**：确保涵盖所有相关的系统和数据源。
    
- **明确对账标准**：制定统一的对账标准，确定每个对账对象的核对规则，确保所有涉及的环节和数据都能够进行一致性校验。
    

**2. 自动化对账流程**

- **自动化对账工具的使用**：使用自动化对账系统或工具来定期进行对账操作，减少人工介入，避免人为错误，提高效率。
    
- **自动对账系统整合**：将不同的对账模块自动化整合到同一个系统中，进行跨系统、跨平台的对账，增加覆盖面。
    

**3. 全量和增量对账**

- **全量对账**：确保对账在规定周期内完成，例如每天进行一次全量对账。
    
- **增量对账**：对一些关键环节进行实时监控和对账，增量对账可以帮助及时发现异常，避免未处理的错误积累。  
    明确对账对象和规则可以在方案环节进行评估，而自动化对账流程可以通过接入自动化对账系统来实现
    

## [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AF%B9%E8%B4%A6%E5%88%86%E7%B1%BB)对账分类

### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%85%A8%E9%87%8F%E5%AF%B9%E8%B4%A6%E4%B8%8E%E5%A2%9E%E9%87%8F%E5%AF%B9%E8%B4%A6)全量对账与增量对账

从对账数据范围的维度来看，数据对账可分为**全量数据对账**和**增量数据对账**两类。 全量数据对账是指对整个数据集进行一次完整的对账，以确保源数据与目标数据之间的一致性。全量数据对账的优点是可以确保数据的完整性和一致性。然而，全量数据对账可能会非常耗时和资源密集，特别是对于大型数据集。此外，全量数据对账通常是离线进行的，这意味着在对账过程中可能会错过实时数据的更新。 增量对账是指对新产生的数据进行对账，以作为对全量对账的补充。

### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E6%89%B9%E5%A4%84%E7%90%86%E5%AF%B9%E8%B4%A6%E5%92%8C%E5%AE%9E%E6%97%B6%E5%AF%B9%E8%B4%A6)批处理对账和实时对账

增量对账又可分为**批处理**对账和**实时对账**两种。 批处理对账是指在一定时间间隔内（例如每分钟、每小时）收集和处理一段时间内的数据，然后在指定时间进行对账。 实时对账则是在数据发生变更的同时进行对账，确保每次数据变更一经发生就能及时对账。

||批处理对账|实时对账|
|:-:|:-:|---|
|适用场景|对实时性要求不高的场景|对实时性要求较高的场景|
|及时性|弱|强|
|灵活性|弱，修复慢|强，快速修复|
|复杂性|低|高|

对比两种对账方法发现，实时对账更适合用于增量对账场景，但是实现的复杂性较高，需要引入消息队列等组件。我们考虑实现一套统一的实时对账系统，使用者只需关心具体的对账逻辑，而无需关心对账事件管理、对账策略、对账结果运营等功能的实现。

## [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AE%9E%E6%97%B6%E5%AF%B9%E8%B4%A6%E5%B9%B3%E5%8F%B0)实时对账平台

考虑到团队当前的实时对账方案是定时从数据库中提取近期变动的数据进行对账，这并非标准的“实时”对账，而仍然基于**批处理**的方式进行。此外，现有方案依赖定时任务调度平台，指定具体的机器执行脚本，只支持单机运行，无法横向扩展，因此存在性能瓶颈。同时，原有系统每次对账都需要单独开发对账脚本，未能实现自动化对账。 针对当前业务中的痛点，我们开发了一套全新的实时对账系统，解决了对账时延、开发工作量大、对账任务和结果缺乏统一管理、以及对账服务存在性能瓶颈等问题。 ![](https://km.woa.com/asset/000100022502005f4f579069054c8d01?height=1233&width=2463) 新方案的实时对账平台通过事件触发（如数据库变更、API生成事件）来启动对账任务，每个任务将对比两个不同数据源，基于数据对比结果进行监控和统计，并支持通过回调机制进行修复。 借助该实时对账平台，用户仅需进行少量配置即可接入，并且能够清晰地查看对账结果、监控情况，并及时接收告警信息。通过这一平台，用户能大幅减少开发工作量。

### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AF%B9%E8%B4%A6%E5%B9%B3%E5%8F%B0%E7%89%B9%E6%80%A7)对账平台特性

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AE%9E%E6%97%B6%E6%80%A7-%E8%A1%A5%E8%B6%B3%E5%85%A8%E9%87%8F%E5%AF%B9%E8%B4%A6)实时性-补足全量对账

实时性是实时对账平台的重要特性，它能够保证数据在产生或变更后能够立即进行对账，从而提高数据准确性和业务效率。具体表现在以下几个方面：

- **即时数据处理**：平台能够实时接收和处理来自各种数据源的数据，无需等待批处理周期，从而大大减少了数据处理的延迟。
    
- **实时异常检测**：平台可以在数据产生或变更后立即进行对账，快速发现和通知任何数据不一致的情况，以便及时进行处理。
    
- **实时报告和通知**：平台提供实时的对账报告和通知，使得用户可以实时了解对账状态和结果，及时发现和解决问题。
    
- **实时数据查询**：平台支持实时查询对账结果，用户可以随时查看最新的对账结果，无需等待对账报告。
    
- **实时数据同步**：平台支持实时数据同步，可以将对账结果实时反馈到业务系统，以便进行后续的业务处理。
    

通过实时性特性，实时对账平台可以实现快速、准确的对账，提高业务运行效率，减少对账错误带来的风险。

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E6%94%AF%E6%8C%81-%E6%94%AF%E6%8C%81%E5%A4%9A%E7%A7%8D%E5%AF%B9%E8%B4%A6%E5%9C%BA%E6%99%AF)多数据源支持-支持多种对账场景

多源对账能力是指实时对账平台能够灵活地支持多种类型的数据源进行对账操作。这种能力使得平台可以适应不同的业务场景和需求，提高了对账效率和准确性。具体表现在以下几个方面：

- **数据源支持**：平台可以处理来自不同数据源（ MySQL、MariaDB、TDSQL-MYSQL、Redis、ElasticSearch、API 接口）的数据。
    
- **数据格式兼容**：平台能够识别和处理多种数据格式，如 MySQL 中的所有格式、Redis 中的STRING和JSON、ElasticSearch 中的 JSON，以便进行对账。
    
- **数据处理适应性**：平台可以根据不同数据源的特点和需求，灵活地调整数据处理策略和对账逻辑。
    
- **扩展性**：平台具有良好的扩展性，可以方便地添加对新数据源类型的支持，以满足未来的业务发展需求。
    
- **易用性**：平台提供统一的接口和配置方式，使得接入和使用多种数据源变得简单易行。
    

通过具备多源对账能力，实时对账平台可以应对各种复杂的对账场景，为企业提供高效、准确的对账服务。

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%8F%AF%E9%85%8D%E7%BD%AE%E5%8C%96-%E5%87%8F%E5%B0%91%E5%BC%80%E5%8F%91%E5%B7%A5%E4%BD%9C%E9%87%8F)可配置化-减少开发工作量

常见的对账需求需要分别对比两个数据源的若干字段，可以是两张 MySQL 数据表的几个字段，可以是 MySQL 的一行数据与 Redis 的一个 Key 对应的 Json 字符串，也可以是两个 API 返回的结果等。经过这层抽象，我们将两个数据源之间的对账做成了可配置化的任务。

- **对账任务配置：**无需编写代码，只需使用对账平台配置触发对账的事件源和待对账的数据源，指定待对账的数据源和数据读取规则和对账策略，即可生成实时对账任务，全程在页面操作。
    
- **对账结果分析：**用户可以在平台直接查看对账结果。
    

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AF%B9%E8%B4%A6%E7%AD%96%E7%95%A5%E6%94%AF%E6%8C%81-%E6%BB%A1%E8%B6%B3%E4%B8%8D%E5%90%8C%E7%9A%84%E9%9C%80%E6%B1%82)对账策略支持-满足不同的需求

灵活的对账策略支持是实时对账平台的一个重要特性，它允许用户根据不同的业务场景和需求选择和配置合适的对账策略，包括延时对账、重试策略和并发策略等。这种灵活性使得平台能够更好地满足各种对账需求，提高对账效率和准确性。具体表现在以下几个方面：

- **延时对账**：平台支持配置延时对账策略，允许用户根据业务需求设置对账的延迟时间，以便在数据可能存在延迟的情况下进行准确的对账。
    
- **重试策略**：平台支持配置重试策略，允许用户在对账过程中遇到错误或异常时自动进行重试，以提高对账的成功率和稳定性。
    
- **灰度策略：**平台支持配置灰度策略，允许只针对部分事件触发对账。
    

通过灵活的对账策略支持，实时对账平台可以更好地满足各种业务场景和需求，提高对账效率和准确性。

### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E5%AF%B9%E8%B4%A6%E5%B9%B3%E5%8F%B0%E5%8E%9F%E7%90%86)对账平台原理

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E6%B5%81%E7%A8%8B%E8%AE%BE%E8%AE%A1)流程设计

![](https://km.woa.com/asset/00010002250200d2430a03b5e4480001?height=1824&width=3537) 基于对实时对账场景的分析，我们将对账任务抽象为事件源、对账规则、策略、回调、运营几个部分。

**事件源**：实时对账事件的触发源，可以是数据库的binlog，也可以是上游服务的api调用，每条 binlog 或 api 对应一次对账事件，触发对应的对账任务；

**规则**：规则分为 API 和平台配置两种。API 即对账平台提供统一的对账接口协议，用户依照协议实现接口完成对账。平台配置即用户在平台配置要对账的**数据源**，并且配置基本的**对账逻辑**，由平台自动完成对账；

**数据源：**对账的主客体，支持DB、Redis、ES、API 和 TDW。从事件源获取到对账事件后，根据对账逻辑的查询条件去数据源查询最新的数据，根据对账逻辑的对比字段完成对账；

**对账逻辑：**对账的具体逻辑。有查询条件和对比字段两部分，收到事件后根据查询条件查询待对账的数据，然后比较待对账的字段；

**策略**：对账策略。包含延时策略（收到对账事件后延时多久进行对账）、重试策略（对账失败后是否重试）和并发策略（控制对账速率）。

**回调**：对账完成后的回调。用户依据平台提供的接口协议实现回调接口，用于对账完成后的回调。使用场景例如对账失败后的数据修复。

**运营**：支持对账结果统计、对账明细查看、对账失败告警以及对账结果报表。

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1)架构设计

![](https://km.woa.com/asset/000100022502007874c80dd31b4c8601?height=879&width=4102) 对账平台提供了 kafka 和 API 两种方式接入事件源。在数据库对账的场景中，我们假设数据昨天晚上已经通过全量对账对齐并修复，想保证第二天数据实时一致，那么可以认为只有当将要对账的其中一个数据表发生了变化，才可能产生不一致，所以在这个场景，我们将数据库的 binlog 作为触发对账的事件源。实际实现上，我们使用腾讯云的数据同步功能将 binlog 接入平台的 kafka 中。还有一些场景，用户想要自己控制触发对账的时机，我们也提供了HTTP API 接口的方式接入事件源。接入事件源后，每一条 binlog 和每次 API 调用均对应一个 event。 每个 event 可以在实时对账平台配置多个对应的task。以数据库对账为例，我们暂且将一个 event 看做数据表 A 的一行数据发生了变化，当 A 表发生变化时，我想要保证冗余了 A 表字段的 B 表以及与 A 表有关联的 C 表的数据符合预期，这时就可以给该事件源配置两个task，当一个 event 过来时，同时触发两个task。 针对每一个任务，我们可以配置若干个 filter。对，这里的 filter 和 trpc-go 框架的 filter很像，是完全可配置的。目前支持的 filter 有上文中提到的对账延时、对账失败重试和灰度。 经过前面的链路，task 会统一发送到一个消息队列中，消息队列我们选择了 RocketMQ。这里新增一个 RocketMQ的原因有几点：

7. **解耦和异步处理**。Kafka 作为事件流的入口，能够确保数据的高效流转，而RocketMQ则能有效地解耦任务处理逻辑。消费者能够从队列中异步地取任务进行处理，减少了生产者（Kafka）的压力。
    
8. **负载均衡**。RocketMQ允许多个消费者并发消费任务，因此在任务量激增的情况下，可以轻松通过增加消费者的数量来扩展处理能力，实现负载均衡。每个消费者都可以独立处理一部分任务，而队列自动调度任务分配给各个消费者。
    
9. **流量削峰**。如果事件源的流量波动较大，RocketMQ可以作为流量削峰的工具，控制任务的消费速率，避免消费者由于短时间内过多的任务压力而崩溃。
    
10. **延迟任务**。RocketMQ 提供了延迟队列的能力，实时对账平台利用该能力可以实现任务的延迟执行。
    

再来看看 RocketMQ 如何设计 Topic 和 Partition。对于实时对账场景，所有的对账任务格式都是一样的，没有消息分类的需求，但是有一些用户希望将自己的业务与其他业务隔离开，实现重点保障的目的。所以，我们将 topic 分为两类，一类是普通 topic，用于存储普通的任务，一类是重保 topic，用于存储需要数据隔离的任务。对于每一个 topic，我们申请 10 个分区，并配置十个消费者进行消费，当消费速度跟不上生产速度时，我们扩充分区数，当分区数到达系统上限（腾讯云的 RocketMQ 每个 topic 的分区上限是 16 个）但消费性能仍然不够时，我们再申请新的 topic，这样就能使用更多的消费者分担压力了。 消费者从 RocketMQ 获取到任务后，执行具体的任务，任务的类型分为配置化和 API 两种。配置化任务允许用户在 Web 管理台进行任务的配置，无需开发即可实现对账逻辑，大大节省开发工作量；API 任务支持用户自行实现对账逻辑，只要按照平台接口协议实现 HTTP 接口，即可实现对账逻辑，适合实现更复杂的对账逻辑。 前面我们从一个 event 的视角了解了架构设计，下面我们再来看看服务如何进行部署。 ![](https://km.woa.com/asset/00010002250200d66ba74b57b0411e01?height=1492&width=4123) 如图所示，该架构设计的核心思想是基于分布式消息系统，通过使用 **Kafka** 和 **RocketMQ** 两种流行的消息队列技术，来实现高效、可靠的事件传输和消费。设计思路包括以下几个关键要素：

1.**事件驱动模型**： 该架构采用事件驱动的设计理念，事件源负责产生数据流并将其推送到消息队列（Kafka 或 RocketMQ）。这种设计使得系统能够解耦生产者和消费者，提供更高的灵活性和可扩展性。

2.**分区和消费者组机制**： 对于每个消息队列（无论是 Kafka 还是 RocketMQ），都使用了**分区**和 **消费者组**机制。分区使得数据可以被分散到多个节点上进行并行处理，从而提升系统的吞吐量。消费者组则保证了多消费者并行处理，同时避免重复消费。

3.**水平扩展**： 通过增加更多的消费者实例、消费者组以及 Pod，架构可以实现横向扩展，从而应对不断增长的消息处理需求。消费者和 Pod 的分布式设计提高了系统的弹性和容错性。

4.**容错与高可用性**： 消费者被分布在多个 Pod 中，保证了系统的容错能力。如果某个 Pod 或消费者出现故障，其他 Pod 和消费者可以继续工作，不会影响整体的消息处理。消息队列本身也支持高可用性，确保消息不会丢失。

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE)任务配置

我们使用公司的低代码平台无极构建了一个 web 管理端，集成了对账任务配置、对账结果明细查看、对账结果报表以及业务实时监控。 ![](https://km.woa.com/asset/00010002250200a35b4e95c20c45a701?height=474&width=2161) 任务配置流程如上图所示，包含事件源配置、数据源配置、对账规则配置和策略配置几个步骤。

11. 事件源配置  
    用户事件源名称和事件源类型后，点击创建，会生成一个全局唯一的事件源 ID。  
    如果事件源是 BINLOG，还需要填写数据库名和数据表名称，对账平台收到 binlog 后能够通过这两个字段识别出对应的事件源。创建好事件源配置后，将 binlog 接入对账平台 kafka 即完成了事件源的接入。  
    如果事件源是 API，主动调用对账平台提供的 API 接口，并将分配的事件源 ID 作为参数传入。
    
12. 数据源配置  
    数据源支持 MySQL、Redis、ElasticSearch 和 API 四种。  
    当数据源类型为 MySQL时，需要提供 IP 地址、端口号、数据库名、用户名以及密码。其中，为了避免密码泄露，我们选择将密码存储在密钥管理系统上，用户只需要在自己的项目中创建好密钥，并授权给实时对账平台即。数据源为 Redis 或 ElasticSearch 时配置也是类似的。  
    当数据类型为 API 时，则需要提供实现接口的北极星以及接口路径。
    
13. 对账规则配置  
    有了前面的事件源和数据源配置后，我们就可以进行对账规则配置了，对账规则分为通用配置任务和自定义任务两种。  
    通用配置任务的配置有以下几个部分。
    
    - 事件源选择。从已配置的事件源中选择一个，用于触发对账。
        
    - 数据源选择。从一配置的数据源中选择两个，表示将要进行对账的两个对象。
        
    - 对账逻辑。如果数据源是 MySQL，需要指定数据表（每个数据源配置代表一个数据库）、查询语句（where 条件后面的部分）和对账字段，其中查询语句需要指定变量，平台会使用事件源中获取到的同名字段对齐进行替换，然后根据 sql 去数据库查询对应的数据。Redis 和 ElasticSearch 的配置也是类似的。  
        经过上面的配置，数据查询语句以及待对账字对账平台会自行将配置转换为对账处理逻辑，从而实现对账的**全配置化**，无需任何开发。  
        而自定义任务需要用户提供北极星地址和接口路径，逻辑由用户自行实现。
        
14. 策略规则配置  
    分为延迟时间、抽样率、重试次数、回调几个配置。
    

#### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E8%BF%90%E8%90%A5%E8%AE%BE%E8%AE%A1)运营设计

为了解决对账结果分析耗时耗力这一痛点，我们也做了很多工作。 首先，我们在 Web 管理台提供了对账失败结果明细展示页面，可以方便的分析出从对账数据源中获取的数据、获取数据的查询语句以及具体不一致的字段，用户几乎不用再去做多余的操作，就能直观的知道对账失败的原因。 其次，我们基于小马报表实现了对账报表页面，可以直观的看到每天、每周以及每月的对账通过情况。 最后，我们基于智研云监控和企微机器人，支持将对账失败结果告警到企业微信群里，方便快速响应。

### [](https://km.woa.com/articles/show/621478?kmref=dailymail_headline#%E6%95%88%E6%9E%9C)效果

**自定义任务配置**：

![](https://km.woa.com/asset/00010002250200e392e521c1aa4b2801?height=400&width=300)

**通用任务配置**： ![](https://km.woa.com/asset/000100022502002776f68291bc4f3d01?height=902&width=696)

**通用任务对账配置**： ![](https://km.woa.com/asset/00010002250200d6d1c169da3a43a701?height=1312&width=604)

**对账失败结果列表**： ![](https://km.woa.com/asset/00010002250200e7ccbf2e3cfd402401?height=1062&width=2954)

**对账失败结果详情**： ![](https://km.woa.com/asset/00010002250200f626979b428b48d201?height=1620&width=1598)

**对账报表**： ![](https://km.woa.com/asset/000100022502008278f3e826024d0201?height=1306&width=2510)