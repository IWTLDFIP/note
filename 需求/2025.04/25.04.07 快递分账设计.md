- 分账回退重入情况?
- 发起分账重入的情况?
https://tapd.woa.com/tapd_fe/20416022/story/detail/1020416022122658244

技术文档
https://iwiki.woa.com/p/4014117289/edit


```

pb地址
https://trpc.rick.woa.com/rick/pb/detail?detail=1&id=60680



引用
1
 <dependency>
2
         <artifactId>PaymentSettlementCenter-stub</artifactId>
3
         <groupId>com.tencent.trade.settlement.stub.api.sharing</groupId>
4
         <version>1.2.9</version>
5
 </dependency>

技术方案文档https://iwiki.woa.com/p/4014117289

接口文档

https://iwiki.woa.com/p/4013458314/edit#%E6%89%A7%E8%A1%8C%E5%88%86%E8%B4%A6

{"requestId":"==2d66245d2b4556044722fbd266127031==","offerId":"1800005801","sessionId":"wechatid","openid":"o9OaOs-ZfOS1R5_8S7KlhtjMtSjI","outTradeNo":"T1358758504770221747","amt":"6318","refundId":"1358848888074551968","reqFrom":"2","refundReason":"0","timestamp":"1744027349","productId":1019,"userId":"535291609","paymentClassify":1,"bizOrderId":"1835109860518134549_1","paymentOrderId":"1358758504770221747","refundType":1,"bizRelOrderId":"1358819040316796928_0","refundImmediately":true,"mchId":"1800005801","subMchId":"1692608207","orderTotal":"6318","payerTotal":"6318"}


{"requestId":"d60a9ff37836f078f29ae03821bf1860","offerId":"1800005801","sessionId":"wechatid","openid":"o9OaOsxghRJamryMn13_yb1hWCpM","outTradeNo":"T1358888929790451743","amt":"2968","refundId":"1358845869891155873","reqFrom":"2","refundReason":"0","timestamp":"1744035074","productId":1019,"userId":"262009991","paymentClassify":1,"bizOrderId":"1835328147935986706_1","paymentOrderId":"1358888929790451743","refundType":1,"bizRelOrderId":"1358925626620190720_0","refundImmediately":true,"mchId":"1800005801","subMchId":"1692608207","orderTotal":"2968","payerTotal":"2968"}





```

分账回退relation表
```
`id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键',

`trade_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '订单分账 biz_rel_order_id 支付单分账 payment_order_id ',

`payment_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '支付订单号（唯一）',

`biz_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '业务订单号（唯一）',

`proxy_channel_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '对应微信支付 transaction_id',

`payment_refund_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '支付中台退款ID',

`biz_refund_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '业务退款ID',

`refund_type` tinyint NOT NULL DEFAULT '0' COMMENT '退款类型 0 未知 1 全额退款 2 部分退款',

`apply_amount` bigint NOT NULL COMMENT '申请退款金额（分）',

`refund_amount` bigint NOT NULL COMMENT '实际退款金额（分）',

`actual_base_return_amount` bigint NOT NULL COMMENT '实际计算回退金额（分）',

`state` tinyint NOT NULL DEFAULT '0' COMMENT '退款单回退处理结果 0 - 初始 1 - 处理成功 2 - 回退失败 3 - 不需要回退',

`description` varchar(80) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT '退款单回退描述',

`create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

`update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',

PRIMARY KEY (`id`),

UNIQUE KEY `unique_trade_payment_order_refund_id` (`trade_id`,`payment_order_id`,`payment_refund_id`
```
分账回退表
```
`id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键',

`product_id` int NOT NULL COMMENT '业务线ID',

`sp_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '服务提供商户ID 打车的运力商ID 商户SAAS的商户ID',

`sp_name` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT 'SP名称',

`platform_sharing_dimension` tinyint NOT NULL COMMENT '平台分账维度（1：支付单分账；2：订单分账）',

`trade_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '订单分账 biz_rel_order_id 支付单分账 payment_order_id ',

`payment_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '支付订单号（唯一）',

`biz_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '业务订单号（唯一）',

`proxy_channel_order_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '对应微信支付 transaction_id',

`sharing_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '商户系统内部的分账单号',

`wx_sharing_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '微信分账单号，微信支付系统返回的唯一标识',

`sharing_return_no` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账系统自己生成分账回退单号',

`wx_sharing_return_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT '微信分账回退单号，微信支付系统返回的唯一标识',

`payment_refund_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '支付中台退款ID',

`biz_refund_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '业务退款ID',

`invest_mch_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账回退的接收商户，对应原分账出资的分账方商户，填写微信支付分配的商户号',

`return_mch_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账接口中的分账接收方商户号',

`amount` int DEFAULT NULL COMMENT '需要从分账接收方回退的金额，单位为分，只能为整数，不能超过原始分账单分出给该接收方的金额',

`description` varchar(80) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT '分账回退的原因描述：用户退款',

`state` tinyint NOT NULL DEFAULT '0' COMMENT '分账回退结果 0 - 初始状态 1 - 处理中 2 - 已成功 3 - 已失败',

`result` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT 'INIT PROCESSING SUCCESS FAILED',

`fail_reason` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL COMMENT '失败原因。包含以下枚举值：ACCOUNT_ABNORMAL : 分账接收方账户异常 TIME_OUT_CLOSED : 超时关单',

`create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '分账回退创建时间',

`finish_time` datetime DEFAULT NULL COMMENT '分账回退完成时间',

PRIMARY KEY (`id`),

UNIQUE KEY `uniq_trade_sharing_return_no` (`trade_id`,`sharing_return_no`) USING BTREE,

UNIQUE KEY `uniq_trade_payment_order_refund_return_mch_id` (`trade_id`,`payment_order_id`,`payment_refund_id`,`return_mch_id`)


```
分账明细表

```
`id` bigint NOT NULL AUTO_INCREMENT,

`product_id` int NOT NULL COMMENT '业务线ID',

`sp_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '服务提供商户ID 打车的运力商ID 商户SAAS的商户ID',

`sp_name` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT 'SP名称',

`platform_sharing_dimension` tinyint NOT NULL COMMENT '平台分账维度（1：支付单分账；2：订单分账）',

`appid` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '微信分配的公众账号ID',

`payment_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '支付订单号（唯一）',

`biz_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '业务订单号（唯一）',

`trade_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '订单分账 biz_rel_order_id 支付单分账 payment_order_id ',

`proxy_channel_order_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '对应微信支付 transaction_id',

`sharing_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '商户分账单号：商户系统内部的分账单号，在商户系统内部唯一',

`wx_sharing_order_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '微信分账单号，微信支付系统返回的唯一标识',

`wx_sharing_detail_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '微信分账明细单号，每笔分账业务执行的明细单号，可与资金账单对账使用',

`settlement_time` bigint NOT NULL DEFAULT '0' COMMENT '订单完单时间 check time',

`invest_mch_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '微信支付分配的子商户号，即分账的出资商户号',

`receive_mch_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账接收方账号：1、类型是MERCHANT_ID时，是商户号（mch_id或者sub_mch_id）2、类型是PERSONAL_OPENID时，是个人openid',

`receive_type` varchar(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账接收方类型：MERCHANT_ID：商户号 PERSONAL_OPENID：个人openid',

`amount` int NOT NULL DEFAULT '0' COMMENT '分账金额，单位为分，只能为整数，不能超过原订单支付金额及最大分账比例金额',

`description` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账的原因描述，分账账单中需要体现',

`state` tinyint NOT NULL COMMENT '分账结果：1、PENDING：待分账 2、SUCCESS：分账成功 3、CLOSED：已关闭',

`fail_reason` varchar(128) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '分账失败原因，当分账结果result为CLOSED（已关闭）时，返回该字段\n1、ACCOUNT_ABNORMAL : 分账接收账户异常\n2、NO_RELATION : 分账关系已解除\n3、RECEIVER_HIGH_RISK : 高风险接收方\n4、RECEIVER_REAL_NAME_NOT_VERIFIED : 接收方未实名\n5、NO_AUTH : 分账权限已解除\n6、 RECEIVER_RECEIPT_LIMIT : 接收方已达收款限额',

`finish_time` bigint NOT NULL DEFAULT '0' COMMENT '分账完成时间 未分账记录存储0',

`sharing_mode` tinyint NOT NULL DEFAULT '1' COMMENT '分账模式（1：实时分账；2：延迟分账）',

`plan_sharing_time` bigint NOT NULL DEFAULT '0' COMMENT '延迟分账-计划分账时间',

`unfreeze_order` tinyint NOT NULL DEFAULT '1' COMMENT '是否解冻订单（1：是；2：否）',

`parent_merchant_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '1 对多 服务商商户号,支付使用服务商模式时对应的服务商商户号，比如腾讯出行服务就是打车的服务商商户号',

`tenant_id` int NOT NULL COMMENT '租户ID',

`user_id` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT '用户ID',

`create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

`update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',

PRIMARY KEY (`id`) USING BTREE,

UNIQUE KEY `uniq_trade_transaction_receive_mch_id` (`trade_id`,`proxy_channel_order_id`,`receive_mch_id`) USING BTREE,

UNIQUE KEY `uniq_trade_payment_order_receive_mch_id` (`trade_id`,`payment_order_id`,`receive_mch_id`) USING BTREE,

UNIQUE KEY `uniq_trade_sharing_order_receive_mch_id` (`trade_id`,`sharing_order_id`,`receive_mch_id`) USING BTREE,

```
